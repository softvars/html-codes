<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js"></script>
    <script type="text/javascript" src="http://underscorejs.org/underscore-min.js"></script>
</head>
<body>
    <div id="graph"></div>
    <div id="donut"></div>
    <script type="text/javascript">

    var reds = ['#FAD0C7', '#F39B90', '#EE746D', '#E9474E', '#B7424B'];
    var greens = ['#DCEDE0', '#B5DABE', '#98CDA7', '#76BF90', '#57977D'];

    // point {day: timestamp, amount: numeric}
    // e.g {day: 1396864800 - 7 aprile 2014 10.00, amount 200}
    var incomesData = [
       {day: 1396656000, amount: 100},
       {day: 1396742400, amount: 500},
       {day: 1396864800, amount: 200},
       {day: 1396964800, amount: 230},
       {day: 1397064800, amount: 600}
        ];
   var incomesDataTwo = [
       {day: 1396656000, amount: 100},
       {day: 1396742400, amount: 500},
       {day: 1396864800, amount: 200},
       {day: 1396964800, amount: 230},
       {day: 1397064800, amount: 600}
        ];
    var outcomesData = [
       {day: 1396656000, amount: 200},
       {day: 1396742400, amount: 100},
       {day: 1396864800, amount: 300},
       {day: 1396964800, amount: 430},
       {day: 1397064800, amount: 422}
        ];
    var balanceData = [
       {day: 1396656000, amount: 0},
       {day: 1396742400, amount: 100},
       {day: 1396864800, amount: 220},
       {day: 1396964800, amount: 130},
       {day: 1397064800, amount: 322}
        ];

    var svgContainer = d3.select("#graph")
        .append("svg");
 //       .attr("width", 1000)
 //       .attr("height", 1000);

    function getDate(d) {
        return new Date(d.day);
    }
    function getMaxAmount(arr) {
        return _.max(arr, function(point){ return point.amount; });
    }

    // get max and min dates - this assumes data is sorted
    var minDate = getDate(incomesData[0]);
    var maxDate = getDate(incomesData[incomesData.length-1]);
    var mergedData = _.union(incomesData, outcomesData, balanceData);
    var maxAmount = getMaxAmount(mergedData).amount;

    var width = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
    //var height = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

    var height = 500;
    var padding = 100;
    var xScale = d3.time.scale().domain([minDate, maxDate]).range([0, width]);
    var yScale = d3.scale.linear().domain([0, maxAmount]).range([height , 0]);

    var lineFunction = d3.svg.line()
        .x(function(d) { return xScale(getDate(d)); })
        .y(function(d) { return yScale(d.amount); })
        .interpolate("linear");

    var lineGraph = svgContainer.append("path")
        .attr("d", lineFunction(incomesData))
        .attr("stroke", "green")
        .attr("stroke-width", 1)
        .attr("fill", "none");

    var lineGraph = svgContainer.append("path")
        .attr("d", lineFunction(outcomesData))
        .attr("stroke", "red")
        .attr("stroke-width", 1)
        .attr("fill", "none");

    var lineGraph = svgContainer.append("path")
        .attr("d", lineFunction(balanceData))
        .attr("stroke", "gray")
        .attr("stroke-width", 1)
        .attr("fill", "none")
        .style("stroke-dasharray", ("3, 3"));

    var incomePoints = svgContainer.selectAll(".point")
         .data(incomesData.slice(1, -1)) //tolgo il primo e l'ultimo punto dal grafico
         .enter().append("svg:circle")
         //.attr("stroke", "black")
         .attr("fill", function(d, i) { return "green";})
         .attr("cx", function(d, i) { return xScale(getDate(d)); })
         .attr("cy", function(d, i) { return yScale(d.amount); })
         .attr("r", function(d, i) { return 3 });

    var outcomePoints = svgContainer.selectAll(".point")
         .data(outcomesData.slice(1, -1))
         .enter().append("svg:circle")
         .attr("stroke", "darkred")
         .attr("fill", function(d, i) { return "white";})
         .attr("cx", function(d, i) { return xScale(getDate(d)); })
         .attr("cy", function(d, i) { return yScale(d.amount); })
         .attr("r", function(d, i) { return 5 });


         /*** DONUT ***/
        var counter = 0; //TODO: resettare ad ogni avvio
        var radius = Math.min(width, height) / 2;
        var colorReds = d3.scale.ordinal().range(reds);
        var arc = d3.svg.arc().outerRadius(radius - 10).innerRadius(radius - 30);
        var pie = d3.layout.pie().sort(null).value(function(d) { return d.amount; });
        var donutContainer = d3.select("#donut")
            .append("svg");
//     .attr("width", width)
//    .attr("height", height)

        var g = donutContainer.selectAll(".arc")
            .data(pie(incomesData))
            .enter().append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
            .attr("class", "arc");

        g.append("path")
            .attr("d", arc)
            .style("fill", function(d) { return colorReds(counter++); });

        g.append("text")
            .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
            .attr("dy", ".35em")
            .style("text-anchor", "middle")
            .text(function(d) { return d.amount; });

    </script>
</body>
</html>